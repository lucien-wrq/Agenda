<?php
function round_to_nearest_hour($datetime) { 
    $rounded_timestamp = round(strtotime($datetime) / 3600) * 3600;
    return date('Y-m-d H:i:s', $rounded_timestamp);
}

if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST['id_event'])) {
    $id_event = $_POST['id_event'];
    $label = isset($_POST['label']) ? $_POST['label'] : '';
    $start_date = isset($_POST['start_date']) ? date('Y-m-d H:i:s', strtotime($_POST['start_date'])) : '';
    $start_date = round_to_nearest_hour($start_date);

    $end_date = isset($_POST['end_date']) ? date('Y-m-d H:i:s', strtotime($_POST['end_date'])) : '';
    $end_date= round_to_nearest_hour($end_date);
    
    $modif_date = new datetime(); 
    $modif_date_formate = $modif_date->format('Y-m-d H:i:s');
    try {
        $db = new PDO('sqlite:../BDD2.db');
        $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    } catch (PDOException $e) {
        die("Erreur de connexion : " . $e->getMessage());
    }

    $sql_update = "UPDATE events SET label = :label, start_date = :start_date, end_date = :end_date, last_modification_date = :last_modification_date WHERE id_event = :id_event";
    $stmt_update = $db->prepare($sql_update);

    $stmt_update->bindParam(':label', $label, PDO::PARAM_STR);
    $stmt_update->bindParam(':start_date', $start_date, PDO::PARAM_STR);
    $stmt_update->bindParam(':end_date', $end_date, PDO::PARAM_STR);
    $stmt_update->bindParam(':id_event', $id_event, PDO::PARAM_STR);
    $stmt_update->bindParam(':last_modification_date', $modif_date_formate, PDO::PARAM_STR);

    try {
        $stmt_update->execute();
        echo "Modification réussie";
    } catch (PDOException $e) {
        echo "Erreur : " . $e->getMessage();
    }

    $db = null;
} else {
    echo "Aucune donnée de modification soumise";
}
?>