<?php

session_start();

// Récupérer les données du formulaire HTML team
$label = isset($_POST['label']) ? $_POST['label'] : '';
$description = isset($_POST['description']) ? $_POST['description'] : '';

date_default_timezone_set('Europe/Paris');
$creation_date = date('Y-m-d H:i:s');

$creator_id = $_SESSION['user_id'];

//créer un agenda 
$type = 'Pro';
$label = isset($_POST['label']) ? $_POST['label'] : '';
$description = isset($_POST['description']) ? $_POST['description'] : '';
$creation_date = date('Y-m-d H:i:s');
$id_agenda = uniqid();

try {
    $db = new PDO('sqlite:../BDD2.db');
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); // Set error mode to exception
} catch (PDOException $e) {
    die("Erreur de connexion : " . $e->getMessage());
}

// Préparer la requête SQL
$sql_1 = "INSERT INTO teams (label, creation_date ,description, creator_id) VALUES (:label, :creation_date, :description, :creator_id)";
$sql_2 = "INSERT INTO agendas (id_agenda, type, label, description, creation_date ) VALUES (:id_agenda,:type, :label, :description, :creation_date)";
$sql_3 = "INSERT INTO teams_has_agendas (id_team, id_agenda) VALUES (LAST_INSERT_ROWID(), :id_agenda)";
// Préparer la requête SQL avec PDO
$stmt_1 = $db->prepare($sql_1);
$stmt_2 = $db->prepare($sql_2);
$stmt_3 = $db->prepare($sql_3);

// Binder les paramètres
$stmt_1->bindParam(':label', $label, PDO::PARAM_STR);
$stmt_1->bindParam(':creation_date', $creation_date, PDO::PARAM_STR);
$stmt_1->bindParam(':description', $description, PDO::PARAM_STR);
$stmt_1->bindParam(':creator_id', $creator_id, PDO::PARAM_INT);


// Binder les paramètres
$stmt_2->bindParam(':type', $type, PDO::PARAM_STR);
$stmt_2->bindParam(':creation_date', $creation_date, PDO::PARAM_STR);
$stmt_2->bindParam(':description', $description, PDO::PARAM_STR);
$stmt_2->bindParam(':id_agenda', $id_agenda, PDO::PARAM_STR);
$stmt_2->bindParam(':label', $label, PDO::PARAM_STR);

// Binder les paramètres
$stmt_3->bindParam(':id_agenda', $id_agenda, PDO::PARAM_STR);

// Exécuter la requête
$stmt_1->execute();
echo "Enregistrement réussi";

// Get the id_team from the teams table
$id_team = $db->lastInsertId();
echo "L'identifiant unique de la dernière ligne insérée est : " . $id_team;

// Prepare the SQL statement for the teams_has_agendas table
$stmt_3 = $db->prepare("INSERT INTO teams_has_agendas (id_team, id_agenda) VALUES (:id_team, :id_agenda)");

// Bind the parameters to the SQL statement
$stmt_3->bindParam(':id_team', $id_team, PDO::PARAM_INT);
$stmt_3->bindParam(':id_agenda', $id_agenda, PDO::PARAM_INT);

// Execute the SQL statement
$stmt_3->execute();
echo "Enregistrement réussi dans la table teams_has_agendas";
header('Location:../../../Front/php/page_admin.php');
// Fermer la connexion
$db = null;

?>