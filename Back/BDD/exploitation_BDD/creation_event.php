<?php

session_start();

// Récupérer les données du formulaire HTML
$label = isset($_POST['label']) ? $_POST['label'] : '';
$start_date = isset($_POST['start_date']) ? date('Y-m-d H:i:s', strtotime($_POST['start_date'])) : '';
$start_date = round_to_nearest_hour($start_date);

$place = isset($_POST['place']) ? $_POST['place'] : '';
$end_date = isset($_POST['end_date']) ? date('Y-m-d H:i:s', strtotime($_POST['end_date'])) : '';
$end_date = round_to_nearest_hour($end_date);

$description =isset($_POST['description']) ? $_POST['description']: '';

date_default_timezone_set('Europe/Paris');
$creation_date = date("Y-m-d H:i:s");
$id_event = uniqid();

$creator_id = $_SESSION['user_id'];



function round_to_nearest_hour($datetime) { 
    $rounded_timestamp = round(strtotime($datetime) / 3600) * 3600;
    return date('Y-m-d H:i:s', $rounded_timestamp);
}


try {
    $db = new PDO('sqlite:../BDD2.db');
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); // Set error mode to exception
} catch (PDOException $e) {
    die("Erreur de connexion : " . $e->getMessage());
}

// Préparer la requête SQL
$sql_1 = "INSERT INTO events (id_event, label, start_date, end_date ,creation_date ,description ,place, creator_id) VALUES (:id_event, :label, :start_date, :end_date, :creation_date, :description, :place, :creator_id)";
$sql_user = "INSERT INTO users_manage_events (id_user, id_event) VALUES (:creator_id, :id_event)";

// Préparer la requête SQL avec PDO
$stmt_1 = $db->prepare($sql_1);

// Binder les paramètres
$stmt_1->bindParam(':place', $place, PDO::PARAM_STR);
$stmt_1->bindParam(':label', $label, PDO::PARAM_STR);
$stmt_1->bindParam(':creation_date', $creation_date, PDO::PARAM_STR);
$stmt_1->bindParam(':start_date', $start_date, PDO::PARAM_STR);
$stmt_1->bindParam(':end_date', $end_date, PDO::PARAM_STR);
$stmt_1->bindParam(':description', $description, PDO::PARAM_STR);
$stmt_1->bindParam(':id_event', $id_event, PDO::PARAM_STR);
$stmt_1->bindParam(':creator_id', $creator_id, PDO::PARAM_INT);

$stmt_user = $db->prepare($sql_user);

//Binder les paramètres
$stmt_user->bindParam(':id_event', $id_event);
$stmt_user->bindParam(':id_user', $creator_id);

// Exécuter la requête
try {
    $stmt_1->execute();
   //$stmt_user->execute();
    echo "Enregistrement réussi";
    header('Location:../../../Front/php/page_admin.php');
} catch (PDOException $e) {
    echo "Erreur : " . $e->getMessage();
}
// Fermer la connexion
$db = null;
?>